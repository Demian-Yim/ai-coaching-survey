import { GoogleGenAI } from "@google/genai";
import type { DiagnosisResult, SurveySubmission } from '../types';

// Fix: Per Gemini API guidelines, the API key must be obtained from `process.env.API_KEY`.
// This change also resolves the TypeScript error: "Property 'env' does not exist on type 'ImportMeta'".
const API_KEY = process.env.API_KEY;

let ai: GoogleGenAI | null = null;
if (API_KEY) {
    ai = new GoogleGenAI({ apiKey: API_KEY });
} else {
    // Fix: Updated the warning message to refer to `API_KEY` instead of `VITE_API_KEY`.
    console.warn("API_KEY environment variable not set. Please update it in your deployment settings. Gemini API features will be disabled.");
}

export const generateDiagnosisFeedback = async (scores: DiagnosisResult['scores']): Promise<string> => {
    if (!ai) {
        return "AI í”¼ë“œë°±ì€ API í‚¤ê°€ ì„¤ì •ë˜ì—ˆì„ ë•Œ ì œê³µë©ë‹ˆë‹¤. í˜„ì¬ëŠ” ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
    }

    // FIX: Per Gemini API guidelines, system instructions should be passed in the `config` object.
    const systemInstruction = "ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ HRD ì»¨ì„¤í„´íŠ¸ì´ì, ë”°ëœ»í•œ ë™ê¸°ë¶€ì—¬ê°€ì´ë©°, ë‚ ì¹´ë¡œìš´ í†µì°°ë ¥ì„ ì§€ë‹Œ AI í˜ì‹  ì½”ì¹˜ 'ë‹¥í„° AI'ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë‹¨ìˆœí•œ ë¶„ì„ì„ ë„˜ì–´, í•œ ì‚¬ëŒì˜ ì„±ì¥ ì ì¬ë ¥ì„ ê¹¨ìš°ê³ , AI ì‹œëŒ€ì— ìì‹ ê°ì„ ê°–ê³  ë‚˜ì•„ê°ˆ ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ê¸¸ì„ ì œì‹œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ, ì „ë¬¸ê°€ì ì´ë©´ì„œë„ ë§¤ìš° ì¹œê·¼í•˜ê³  ê³µê°ì ì¸ ì–´íˆ¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.";
    const prompt = `
        í•œ í•™ìŠµìì˜ AI ì—­ëŸ‰ ìê°€ ì§„ë‹¨ ê²°ê³¼ê°€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. ì´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, í•´ë‹¹ í•™ìŠµì í•œ ì‚¬ëŒë§Œì„ ìœ„í•œ ë§¤ìš° ê¹Šì´ ìˆê³ , ê°ë™ì ì´ë©°, ì••ë„ì ìœ¼ë¡œ ìƒì„¸í•œ ë§ì¶¤í˜• ì§„ë‹¨ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. ê¸°ì¡´ë³´ë‹¤ 3ë°° ë” ìƒì„¸í•˜ê³ , êµ¬ì²´ì ì´ë©°, ì‹¤í–‰ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

        [ìê°€ ì§„ë‹¨ ì ìˆ˜ (5ì  ë§Œì )]
        - ì´í•´ (Understand): ${scores.understanding}ì 
        - í™œìš© (Use): ${scores.application}ì 
        - ë¹„íŒì  ì‚¬ê³  (Critical Thinking): ${scores.criticalThinking}ì 

        ì•„ë˜ì˜ í˜•ì‹ê³¼ ì§€ì¹¨ì„ ë°˜ë“œì‹œ, ê·¸ë¦¬ê³  ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì—¬, í’ë¶€í•˜ê³  ê¹Šì´ ìˆëŠ” ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

        ---

        ### **[ì¢…í•© ì§„ë‹¨: ë‹¹ì‹ ì˜ AI ì„±ì¥ ì ì¬ë ¥ í”„ë¡œí•„]**

        (ì ìˆ˜ ë¶„í¬ë¥¼ ì¢…í•©ì ìœ¼ë¡œ í•´ì„í•˜ì—¬, í•™ìŠµìì˜ í˜„ì¬ ìƒíƒœë¥¼ 3~4 ë¬¸ì¥ì˜ í¥ë¯¸ë¡­ê³  ê¸ì •ì ì¸ ë¹„ìœ ë‚˜ ìŠ¤í† ë¦¬ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´, 'ìµœê³ ê¸‰ F1 ìë™ì°¨ ì—”ì§„ì„ ê°€ì¡Œì§€ë§Œ, ì•„ì§ ìµìˆ™í•œ ë™ë„¤ ê¸¸ë§Œ ë‹¬ë¦¬ê³  ìˆëŠ” ë“œë¼ì´ë²„' ì™€ ê°™ì´ í‘œí˜„í•˜ì—¬ ì§„ë‹¨ ê²°ê³¼ë¥¼ ë§¤ë ¥ì ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ ë¹„ìœ ì— ì–´ìš¸ë¦¬ëŠ” **ë…ì°½ì ì¸ í”„ë¡œí•„ ìœ í˜• ì´ë¦„**ì„ ë¶€ì—¬í•´ì£¼ì„¸ìš”. ì˜ˆ: "ì „ëµì  íƒí—˜ê°€", "ì‹¤ìš©ì£¼ì˜ì  í–‰ë™ê°€")

        ### **[ê°•ì  ë¶„ì„: ì´ë¯¸ ë‹¹ì‹ ì˜ ì†ì— ì¥ì–´ì§„ ê°•ë ¥í•œ ë¬´ê¸° ğŸš€]**

        (ê°€ì¥ ë†’ì€ ì ìˆ˜ë¥¼ ë°›ì€ ì—­ëŸ‰ì„ ì¤‘ì‹¬ìœ¼ë¡œ, ì´ê²ƒì´ ì™œ ì¤‘ìš”í•œ ê°•ì ì¸ì§€, ì‹¤ì œ ì—…ë¬´ì—ì„œ ì–´ë–»ê²Œ ê¸ì •ì ìœ¼ë¡œ ë°œíœ˜ë  ìˆ˜ ìˆëŠ”ì§€ **êµ¬ì²´ì ì¸ ì—…ë¬´ ì‹œë‚˜ë¦¬ì˜¤ 2ê°€ì§€ ì´ìƒ**ì„ ë“¤ì–´ 4~5 ë¬¸ì¥ìœ¼ë¡œ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤. ì¹­ì°¬ê³¼ ê²©ë ¤ë¥¼ í†µí•´ í•™ìŠµìê°€ ìì‹ ì˜ ê°•ì ì„ ëª…í™•íˆ ì¸ì§€í•˜ê³  ìì‹ ê°ì„ ê°–ë„ë¡ ë§Œë“¤ì–´ì£¼ì„¸ìš”. "ë‹¹ì‹ ì€ ì´ë¯¸..." ì™€ ê°™ì€ í™•ì‹ ì— ì°¬ í‘œí˜„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.)

        ### **[ì„±ì¥ ê¸°íšŒ: ë” ë†’ì€ ê³³ìœ¼ë¡œ ì´ëŒì–´ ì¤„ ì ì¬ë ¥ì˜ ì”¨ì•— ğŸŒ±]**

        (ê°€ì¥ ë‚®ì€ ì ìˆ˜ë¥¼ ë°›ì€ ì—­ëŸ‰ì„ ì¤‘ì‹¬ìœ¼ë¡œ, ì´ê²ƒì´ ë¶€ì¡±í•  ë•Œ ê²ªì„ ìˆ˜ ìˆëŠ” ì–´ë ¤ì›€ì„ ì§§ê²Œ ì–¸ê¸‰í•œ í›„, ì´ ì—­ëŸ‰ì„ ê°œë°œí–ˆì„ ë•Œ ì–´ë–¤ **ë†€ë¼ìš´ ë³€í™”ì™€ ì„±ì¥**ì„ ê²½í—˜í•˜ê²Œ ë ì§€ 4~5 ë¬¸ì¥ì˜ í¬ë§ì ì¸ ìŠ¤í† ë¦¬í…”ë§ìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤. 'ê°œì„ ì 'ì´ë‚˜ 'ë¶€ì¡±í•œ ì 'ì´ë¼ëŠ” ë‹¨ì–´ ëŒ€ì‹  'ì„±ì¥ ê¸°íšŒ', 'ì ì¬ë ¥'ì´ë¼ëŠ” ê¸ì •ì ì¸ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ë™ê¸°ë¥¼ ë¶€ì—¬í•´ì£¼ì„¸ìš”. ì´ ì—­ëŸ‰ì´ ì™œ ë‹¹ì‹ ì˜ ê°•ë ¥í•œ ë¬´ê¸°(ê°•ì )ì™€ ê²°í•©ë˜ì—ˆì„ ë•Œ ì—„ì²­ë‚œ ì‹œë„ˆì§€ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ”ì§€ ì—°ê²°í•´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”.)

        ### **[ìƒì„¸ Action Plan: ë‚´ì¼ì„ ë°”ê¾¸ëŠ” ì´ˆê°œì¸í™” ì‹¤ì²œ ë¡œë“œë§µ]**

        (ì•„ë˜ ì„¸ ê°€ì§€ ì‹œê°„ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´, ì´ 6ê°œ ì´ìƒì˜ êµ¬ì²´ì ì´ê³  ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ í”Œëœì„ ì œì‹œí•©ë‹ˆë‹¤. ê° í•­ëª©ì€ 'ë¬´ì—‡ì„(What)', 'ì–´ë–»ê²Œ(How)', 'ì™œ(Why)'ê°€ ëª…í™•íˆ ë“œëŸ¬ë‚˜ë„ë¡, ë§ˆì¹˜ ì˜†ì—ì„œ ì½”ì¹˜ê°€ ì§ì ‘ ì•Œë ¤ì£¼ë“¯ì´ ì¹œì ˆí•˜ê³  ìƒì„¸í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.)

        *   **ğŸ¯ 1. ì§€ê¸ˆ ë‹¹ì¥ ì‹œì‘í•˜ê¸° (Today's Quick-Win)**
            *   (ì•¡ì…˜ í”Œëœ 1: ì˜¤ëŠ˜ í‡´ê·¼ ì „ê¹Œì§€ 10ë¶„ë§Œ íˆ¬ìí•´ì„œ ì¦‰ê°ì ì¸ ì„±ê³µ ê²½í—˜ì„ í•  ìˆ˜ ìˆëŠ” ë§¤ìš° ì‘ê³  êµ¬ì²´ì ì¸ ë¯¸ì…˜. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ì§ˆë¬¸ì„ ChatGPTì—ê²Œ ë˜ì ¸ë³´ê¸°, íŠ¹ì • ê¸°ëŠ¥ ì‚¬ìš©í•´ë³´ê¸° ë“±)
            *   (ì•¡ì…˜ í”Œëœ 2: AIì— ëŒ€í•œ ì‹¬ë¦¬ì  ì¥ë²½ì„ ë‚®ì¶”ê³  í¥ë¯¸ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ì¬ë¯¸ìˆëŠ” í™œë™ ì œì•ˆ.)

        *   **ğŸ“… 2. ì´ë²ˆ ì£¼ì— ë§ˆìŠ¤í„°í•˜ê¸° (This Week's Mission)**
            *   (ì•¡ì…˜ í”Œëœ 3: í˜„ì¬ ê°€ì¥ ë§ì´ í•˜ê³  ìˆëŠ” ì—…ë¬´(ì˜ˆ: ë³´ê³ ì„œ ì‘ì„±, ì´ë©”ì¼ ë‹µì¥)ì— ë°”ë¡œ ì ìš©í•˜ì—¬ ì‹œê°„ì„ ë‹¨ì¶•í•˜ê±°ë‚˜ ê²°ê³¼ë¬¼ì˜ ì§ˆì„ ë†’ì¼ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ AI í™œìš©ë²•. **ì‹¤ì œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ**ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.)
            *   (ì•¡ì…˜ í”Œëœ 4: ë‚®ì€ ì—­ëŸ‰ì„ ë³´ì™„í•˜ê¸° ìœ„í•´ ì´ë²ˆ ì£¼ ë™ì•ˆ ê¾¸ì¤€íˆ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” í•™ìŠµ ìŠµê´€ì´ë‚˜ ì¶”ì²œ ìë£Œ(íŠ¹ì • ìœ íŠœë¸Œ ì±„ë„, ì•„í‹°í´ ë“±) ì œì‹œ.)

        *   **ğŸš€ 3. í•œ ë‹¬ ì•ˆì— ì „ë¬¸ê°€ë¡œ ê±°ë“­ë‚˜ê¸° (1-Month Growth Path)**
            *   (ì•¡ì…˜ í”Œëœ 5: í˜„ì¬ ê°•ì ì„ ë”ìš± ê°•í™”í•˜ì—¬ ìì‹ ë§Œì˜ ë…ë³´ì ì¸ ì „ë¬¸ ì˜ì—­ì„ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ” ì‹¬í™” í•™ìŠµ ë°©ì•ˆ ë˜ëŠ” ê°œì¸ í”„ë¡œì íŠ¸ ì œì•ˆ.)
            *   (ì•¡ì…˜ í”Œëœ 6: ì¥ê¸°ì ì¸ ê´€ì ì—ì„œ AI ì‹œëŒ€ì˜ ì „ë¬¸ê°€ë¡œ ì„±ì¥í•˜ê¸° ìœ„í•œ ì „ëµì  ì œì–¸. ì˜ˆë¥¼ ë“¤ì–´, ë™ë£Œë“¤ì—ê²Œ ë…¸í•˜ìš° ê³µìœ í•˜ê¸°, ì‚¬ë‚´ ìŠ¤í„°ë”” ê·¸ë£¹ ë§Œë“¤ê¸° ë“±)
    
        ### **[ë§ˆì§€ë§‰ìœ¼ë¡œ, ë‹¥í„° AIì˜ ì‘ì› ë©”ì‹œì§€]**

        (ì§„ë‹¨ ê²°ê³¼ëŠ” í˜„ì¬ì˜ ìœ„ì¹˜ë¥¼ ë³´ì—¬ì¤„ ë¿, ë‹¹ì‹ ì˜ ê°€ëŠ¥ì„±ì„ ì œí•œí•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”. AIëŠ” ë„êµ¬ì¼ ë¿, ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ë‹¹ì‹ ì˜ ì˜ì§€ì™€ í˜¸ê¸°ì‹¬ì´ë¼ëŠ” ì ì„ ë”°ëœ»í•œ ë©”ì‹œì§€ë¡œ ì „ë‹¬í•˜ë©°, ì•ìœ¼ë¡œì˜ ì„±ì¥ì„ ì§„ì‹¬ìœ¼ë¡œ ì‘ì›í•˜ë©° ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.)
        
        ---
    `;

    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: {
                systemInstruction: systemInstruction,
            },
        });
        return response.text;
    } catch (error) {
        console.error("Error generating feedback from Gemini:", error);
        return "AI í”¼ë“œë°± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
    }
};


const formatDataForPrompt = (data: {name: string; value: any}[] | undefined) => {
    if (!data) return 'N/A';
    return data.map(item => `${String(item.name || '').replace(/[:\n\r]/g, '')}: ${item.value}ëª…`).join(', ');
};


export const generateDashboardSummary = async (analysisData: any): Promise<string> => {
    if (!ai || analysisData.total === 0) {
        return "ë¶„ì„í•  ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šê±°ë‚˜ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    }

    const { total, avgCapability, jobRoles, aiPolicies, tools, experiences } = analysisData;

    // FIX: Per Gemini API guidelines, system instructions should be passed in the `config` object.
    const systemInstruction = "ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ê°€ì´ì êµìœ¡ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.";
    const prompt = `
        'AI í™œìš© ì—­ëŸ‰ ê°•í™”' ê³¼ì • ì°¸ì—¬ì ${total}ëª…ì˜ ì‚¬ì „ ì§„ë‹¨ ë°ì´í„°ê°€ ì£¼ì–´ì¡ŒìŠµë‹ˆë‹¤.

        **1. ì—­ëŸ‰ ë¶„ì„ (5ì  ë§Œì )**
        - í‰ê·  'ì´í•´' ì ìˆ˜: ${avgCapability.find((d: any) => d.name === 'ì´í•´')?.score || 'N/A'}
        - í‰ê·  'í™œìš©' ì ìˆ˜: ${avgCapability.find((d: any) => d.name === 'í™œìš©')?.score || 'N/A'}
        - í‰ê·  'ë¹„íŒì  ì‚¬ê³ ' ì ìˆ˜: ${avgCapability.find((d: any) => d.name === 'ë¹„íŒì  ì‚¬ê³ ')?.score || 'N/A'}

        **2. ì°¸ì—¬ì íŠ¹ì„±**
        - ì—­í•  ë¶„í¬: ${formatDataForPrompt(jobRoles)}
        - ì¡°ì§ AI ì •ì±…: ${formatDataForPrompt(aiPolicies)}
        - ìì£¼ ì“°ëŠ” AI íˆ´: ${formatDataForPrompt(tools)}
        - HR ê²½ë ¥: ${formatDataForPrompt(experiences)}

        ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì´ ê³¼ì •ì˜ ë‹´ë‹¹ ê°•ì‚¬ë¥¼ ìœ„í•œ "í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ë° ê°•ì˜ ìš´ì˜ ì œì–¸"ì„ ìš”ì•½í•´ì£¼ì„¸ìš”.
        ì°¸ì—¬ìë“¤ì˜ ê°•ì , ì•½ì , ë°°ê²½ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ ê°•ì˜ì—ì„œ íŠ¹ë³„íˆ ê°•ì¡°í•´ì•¼ í•  í¬ì¸íŠ¸ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
        
        ê²°ê³¼ëŠ” ë‹¤ìŒ í˜•ì‹ì— ë§ì¶° í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

        **[ì¢…í•© ì¸ì‚¬ì´íŠ¸]**
        (ë°ì´í„°ë¥¼ ì¢…í•©í•˜ì—¬ ì°¸ì—¬ì ê·¸ë£¹ì˜ í•µì‹¬ì ì¸ íŠ¹ì§•, ê°•ì , ê·¸ë¦¬ê³  ê°€ì¥ ë‘ë“œëŸ¬ì§€ëŠ” ì„±ì¥ í•„ìš” ì˜ì—­ì„ 3-4 ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½)

        **[ì£¼ìš” ê³ ë ¤ì‚¬í•­]**
        (ì°¸ì—¬ìë“¤ì˜ ë‹¤ì–‘í•œ ë°°ê²½(ì •ì±…, ì‚¬ìš©í•˜ëŠ” íˆ´, ê²½ë ¥ ë“±)ì„ ê³ ë ¤í–ˆì„ ë•Œ ê°•ì˜ ìš´ì˜ ì‹œ ì£¼ì˜í•´ì•¼ í•  ì ì´ë‚˜ ë§ì¶¤í™”ê°€ í•„ìš”í•œ ë¶€ë¶„ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ë¶„ì„)
        
        **[ê°•ì˜ ìš´ì˜ ì œì–¸]**
        - (ì œì–¸ 1: ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ê°•ì˜ ì´ˆë°˜ì— ê°•ì¡°í•´ì•¼ í•  ë‚´ìš©)
        - (ì œì–¸ 2: ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ì¶”ì²œí•˜ëŠ” ê·¸ë£¹ í™œë™ì´ë‚˜ ì‹¤ìŠµ ì£¼ì œ)
        - (ì œì–¸ 3: ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ì°¸ì—¬ìë“¤ì˜ ë§Œì¡±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ íŒ)
    `;

    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: {
                systemInstruction: systemInstruction,
            },
        });
        return response.text;
    } catch (error)
{
        console.error("Error generating summary from Gemini:", error);
        return "AI ëŒ€ì‹œë³´ë“œ ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
};